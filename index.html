<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Classroom Visualiser</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" type="image/png" href="icon-192.png" />
  <style>
    html, body { height: 100%; width: 100%; margin: 0; padding: 0; background: black; overflow: hidden; font-family: sans-serif; }
    #viewport { position: fixed; inset: 0; background: black; overflow: hidden; }
    #videoWrapper { position: absolute; left: 50%; top: 50%; transform-origin: center center; will-change: transform, width, height; z-index: 1; }
    video { display: block; width: 100%; height: 100%; object-fit: cover; background: black; }
    #overlay { position: fixed; inset: 0; pointer-events: none; z-index: 20; background: rgba(255,105,180,0); }
    #control-toggle { position: fixed; right: 15px; bottom: 15px; z-index: 30; background: rgba(0,0,0,0.6); color: white; padding: 7px 10px; border-radius: 8px; cursor: pointer; font-size: 14px; }
    #controls { position: fixed; right: 15px; bottom: 60px; z-index: 30; background: rgba(0,0,0,0.75); color: white; padding: 12px; border-radius: 10px; display: none; width: 220px; box-sizing: border-box; font-size: 13px; }
    #controls label { display: block; margin: 8px 0 4px; }
    #controls input[type="range"], #controls input[type="color"], #controls select { width: 100%; box-sizing: border-box; }
  </style>
</head>
<body>
  <div id="viewport">
    <div id="videoWrapper">
      <video id="video" autoplay playsinline muted></video>
    </div>
  </div>

  <div id="overlay" aria-hidden="true"></div>

  <div id="control-toggle">▲</div>
  <div id="controls" aria-hidden="true">
    <label for="cameraSelect">Camera</label>
    <select id="cameraSelect"></select>

    <label for="qualitySelect">Quality</label>
    <select id="qualitySelect">
      <option value="smooth">Smooth (1080p)</option>
      <option value="max">Max resolution</option>
    </select>

    <label for="tintColor">Tint colour</label>
    <input type="color" id="tintColor" value="#ff69b4">

    <label for="tintOpacity">Tint opacity</label>
    <input type="range" id="tintOpacity" min="0" max="100" value="0">

    <label for="rotation">Rotate</label>
    <select id="rotation">
      <option value="0">0°</option>
      <option value="180">180°</option>
    </select>
  </div>

  <script>
    console.log("Script loaded ✅");

    const video = document.getElementById('video');
    const wrapper = document.getElementById('videoWrapper');
    const overlay = document.getElementById('overlay');
    const toggleBtn = document.getElementById('control-toggle');
    const controls = document.getElementById('controls');
    const tintColor = document.getElementById('tintColor');
    const tintOpacity = document.getElementById('tintOpacity');
    const rotation = document.getElementById('rotation');
    const cameraSelect = document.getElementById('cameraSelect');
    const qualitySelect = document.getElementById('qualitySelect');

    // restore settings
    const savedColor = localStorage.getItem('tintColor');
    const savedOpacity = localStorage.getItem('tintOpacity');
    const savedRotation = localStorage.getItem('rotation');
    const savedCameraId = localStorage.getItem('cameraId');
    const savedQuality = localStorage.getItem('qualityMode');

    if(savedColor) tintColor.value = savedColor;
    if(savedOpacity) tintOpacity.value = savedOpacity;
    if(savedRotation) rotation.value = savedRotation;
    if(savedQuality) qualitySelect.value = savedQuality;

    function hexToRgba(hex, alpha) {
      const h = hex.replace('#','');
      const r = parseInt(h.length===3?h[0]+h[0]:h.slice(0,2),16);
      const g = parseInt(h.length===3?h[1]+h[1]:h.slice(2,4),16);
      const b = parseInt(h.length===3?h[2]+h[2]:h.slice(4,6),16);
      return `rgba(${r},${g},${b},${alpha})`;
    }

    function updateOverlay(){
      const a = (parseInt(tintOpacity.value,10)||0)/100;
      overlay.style.background = hexToRgba(tintColor.value,a);
    }

    tintColor.addEventListener('input', ()=>{ localStorage.setItem('tintColor', tintColor.value); updateOverlay(); });
    tintOpacity.addEventListener('input', ()=>{ localStorage.setItem('tintOpacity', tintOpacity.value); updateOverlay(); });

    toggleBtn.addEventListener('click', ()=>{
      const showing = controls.style.display!=='none';
      controls.style.display = showing?'none':'block';
      controls.setAttribute('aria-hidden', showing?'true':'false');
      toggleBtn.textContent = showing?'▲':'▼';
    });

    function applyTransform(){
      const deg = parseInt(rotation.value,10)||0;
      const vw = video.videoWidth || 1920;
      const vh = video.videoHeight || 1080;
      wrapper.style.width = vw+'px';
      wrapper.style.height = vh+'px';
      const W = window.innerWidth;
      const H = window.innerHeight;
      wrapper.style.transform = `translate(-50%,-50%) rotate(${deg}deg) scale(${Math.max(W/vw,H/vh)})`;
    }
    rotation.addEventListener('change', ()=>{ localStorage.setItem('rotation', rotation.value); applyTransform(); });

    qualitySelect.addEventListener('change', ()=>{ localStorage.setItem('qualityMode', qualitySelect.value); if(cameraSelect.value) initCamera(cameraSelect.value); });

    async function initCamera(deviceId){
      try{
        const quality = qualitySelect.value;
        let constraints;
        if(quality==='smooth'){
          constraints = { video: { deviceId: deviceId?{exact:deviceId}:undefined, width:{ideal:1920}, height:{ideal:1080}, frameRate:{ideal:30} } };
        } else {
          constraints = { video: { deviceId: deviceId?{exact:deviceId}:undefined, width:{ideal:9999}, height:{ideal:9999} } };
        }
        console.log("Requesting camera with constraints:", constraints);
        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = stream;
        const track = stream.getVideoTracks()[0];
        const settings = track.getSettings();
        console.log(`Camera started: ${settings.width}x${settings.height} @ ${settings.frameRate||'unknown'}fps`);
        video.addEventListener('loadedmetadata', ()=>{ applyTransform(); }, {once:true});
      }catch(err){
        console.error("Camera error:", err);
        if(err.name==="NotAllowedError"){
          alert("Camera access was blocked. Please allow camera permissions in your browser settings.");
        } else if(err.name==="NotFoundError"){
          alert("No camera found. Please connect a camera and reload.");
        } else {
          alert("Error accessing camera: "+err.message);
        }
      }
    }

    async function populateCameras(){
      const devices = await navigator.mediaDevices.enumerateDevices();
      const videoDevices = devices.filter(d=>d.kind==='videoinput');
      cameraSelect.innerHTML = '';
      videoDevices.forEach((d,i)=>{
        const opt=document.createElement('option');
        opt.value=d.deviceId;
        opt.text=d.label||`Camera ${i+1}`;
        cameraSelect.appendChild(opt);
      });
      const selected = savedCameraId&&videoDevices.some(d=>d.deviceId===savedCameraId)?savedCameraId:videoDevices[0]?.deviceId;
      if(selected){ cameraSelect.value=selected; initCamera(selected); }
    }
    cameraSelect.addEventListener('change', ()=>{ const id=cameraSelect.value; localStorage.setItem('cameraId',id); initCamera(id); });

    // Always request permissions on load
    navigator.mediaDevices.getUserMedia({video:true})
      .then(stream=>{ stream.getTracks().forEach(t=>t.stop()); populateCameras(); })
      .catch(err=>{
        console.error("Initial permission request failed:", err);
        if(err.name==="NotAllowedError"){
          alert("You must allow camera access for this app to work. Please check browser settings.");
        }
      });

    updateOverlay();
    window.addEventListener('resize', applyTransform);

    // Wake lock
    if("wakeLock" in navigator){ navigator.wakeLock.request("screen").catch(e=>console.warn("WakeLock error",e)); }

    // Service Worker
    if("serviceWorker" in navigator){
      navigator.serviceWorker.register("sw.js")
        .then(reg=>console.log("Service Worker registered:", reg.scope))
        .catch(err=>console.warn("SW registration failed:",err));
    }
  </script>
</body>
</html>
